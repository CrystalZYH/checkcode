/*! checkcode - v1.1 - 2013-07-26 1:35:45 PM
* Copyright (c) 2013 棪木; Licensed  */
KISSY.add("gallery/checkcode/1.1/index",function(a){var b=a.DOM,c=(a.Event,1),d=/^[\da-zA-Z]{4,6}$/,e=-1!==navigator.userAgent.indexOf("Windows"),f=a.UA.ie,g=a.UA.firefox,h=".{{prefixCls}}checkcode-img,.{{prefixCls}}checkcode-audio{width:175px;height:32px;line-height:32px;position:absolute;}.{{prefixCls}}checkcode-audio{display:none;}.{{prefixCls}}checkcode-img img,.{{prefixCls}}checkcode-audio audio{float:left;display:inline;width:100px;height:30px;border:1px solid #CDCDCD;cursor:pointer;}.{{prefixCls}}checkcode-refresh{display:none;width:100px;height:30px;vertical-align:middle;border:1px solid #CDCDCD;position:absolute;left:0;top:0;cursor:pointer;}.{{prefixCls}}audio-state{float:left;display:inline;width:100px;height:30px;border:1px solid #CDCDCD;position:relative;}.{{prefixCls}}audio-state-text{display:block;width:70px;height:30px;padding-left:30px;font-size:12px;color:#999;text-decoration:none;background:url(http://img01.taobaocdn.com/tps/i1/T1HVriXnVeXXbjRy2i-21-169.png) no-repeat 10px -93px;z-index:1;position:absolute;cursor:text;}.{{prefixCls}}audio-state-text:hover{text-decoration:none;}.{{prefixCls}}audio-state-progress{width:0;height:30px;background-color:#186BCA;position:absolute;left:0;top:0;z-index:0;}.{{prefixCls}}audio-over{width:100px;padding-left:0;color:#186BCA;text-align:center;background:none;cursor:pointer;}.{{prefixCls}}audio-over:hover{text-decoration:underline;}.{{prefixCls}}checkcode-refresher{float:left;display:inline;width:32px;height:32px;vertical-align:top;text-indent:-9999em;outline:none;border-right:1px solid #DDD;background:url(http://img01.taobaocdn.com/tps/i1/T1HVriXnVeXXbjRy2i-21-169.png) no-repeat 7px -145px;}.{{prefixCls}}checkcode-switcher{float:left;display:inline;width:32px;height:32px;vertical-align:top;text-indent:-9999em;outline:none;background:url(http://img01.taobaocdn.com/tps/i1/T1HVriXnVeXXbjRy2i-21-169.png) no-repeat 0 0;}.{{prefixCls}}checkcode-refresher,.{{prefixCls}}checkcode-switcher{filter:alpha(opacity=70);opacity:0.7;}.{{prefixCls}}checkcode-refresher:hover,.{{prefixCls}}checkcode-switcher:hover{filter:alpha(opacity=100);opacity:1;border-color:#EAEAEA;}.{{prefixCls}}audio-switcher{background-position:6px -40px;}.{{prefixCls}}img-switcher{background-position:5px 10px;}",i={template:'<div class="{prefixCls}checkcode-img" id="J_ImgCode{uid}"><img id="J_CheckCodeImg{uid}" width="100" height="30" onmousedown="return false;"/><a href="#nogo" onmousedown="return false;" role="button" title="\u91cd\u65b0\u83b7\u53d6\u9a8c\u8bc1\u7801" aria-label="\u91cd\u65b0\u83b7\u53d6\u9a8c\u8bc1\u7801" id="J_ImgRefresher{uid}" class="{prefixCls}checkcode-refresher">\u91cd\u65b0\u83b7\u53d6\u9a8c\u8bc1\u7801</a><a href="#nogo" onmousedown="return false;" role="button" title="\u83b7\u53d6\u8bed\u97f3\u9a8c\u8bc1\u7801" aria-label="\u83b7\u53d6\u8bed\u97f3\u9a8c\u8bc1\u7801" id="J_AudioSwitcher{uid}" class="{prefixCls}checkcode-switcher {prefixCls}audio-switcher">\u83b7\u53d6\u8bed\u97f3\u9a8c\u8bc1\u7801</a></div><div class="{prefixCls}checkcode-audio" id="J_AudioCode{uid}"><span class="{prefixCls}audio-state" id="J_AudioState{uid}"><a href="#nogo" class="{prefixCls}audio-state-text" id="J_AudioStateText{uid}" onmousedown="return false;"></a><span class="{prefixCls}audio-state-progress" id="J_AudioStateProgress{uid}"></span></span><a href="#nogo" role="button" onmousedown="return false;" title="\u91cd\u65b0\u83b7\u53d6\u9a8c\u8bc1\u7801" aria-label="\u91cd\u65b0\u83b7\u53d6\u9a8c\u8bc1\u7801" id="J_AudioRefresher{uid}" class="{prefixCls}checkcode-refresher">\u91cd\u65b0\u83b7\u53d6\u9a8c\u8bc1\u7801</a><a href="#nogo" role="button" onmousedown="return false;" title="\u83b7\u53d6\u56fe\u7247\u9a8c\u8bc1\u7801" aria-label="\u83b7\u53d6\u56fe\u7247\u9a8c\u8bc1\u7801" id="J_ImgSwitcher{uid}" class="{prefixCls}checkcode-switcher {prefixCls}img-switcher">\u83b7\u53d6\u56fe\u7247\u9a8c\u8bc1\u7801</a></div>',getImgURL:"{apiserver}/get_img?identity={identity}&sessionid={sessionid}&kjtype={type}",checkImgURL:"{apiserver}/check_img?identity={identity}&sessionid={sessionid}&delflag=0",getAudioURL:"{apiserver}/get_audio?identity={identity}&sessionid={sessionid}",checkAudioURL:"{apiserver}/check_audio?identity={identity}&sessionid={sessionid}&delflag=0"},j=a.now(),k=a.now(),l={},m=function(b){return this instanceof m?(b=a.isObject(b)?b:{},this.input=b.input&&a.one(b.input),this.container=b.container&&a.one(b.container),this.prefixCls=a.isString(b.prefixCls)?b.prefixCls:"",this.identity=b.identity||"",this.sessionid=b.sessionid||"",this.apiserver=a.isString(b.apiserver)&&b.apiserver?b.apiserver:"http://pin.aliyun.com",this.type=b.type||"default",this.checkedCode="",this.uid=c++,this._init(),void 0):new m(b)};return a.augment(m,a.EventTarget,{_init:function(){return this.container&&this.input&&this.identity&&this.sessionid?this.INITED?this:(this.createStyle(),this.create(),this.bind(),this.INITED=!0,this):void 0},createStyle:function(){var a=h.replace(/{{prefixCls}}/g,this.prefixCls),c=b.create("<style>",{type:"text/css"});c.styleSheet?c.styleSheet.cssText=a:c.appendChild(document.createTextNode(a)),b.append(c,"head")},create:function(){var b=this.uid,c=a.substitute(i.template,{prefixCls:this.prefixCls,uid:b});this.container.html(c),this.imgCode=a.one("#J_ImgCode"+b),this.audioCode=a.one("#J_AudioCode"+b),this.imgSwitcher=a.one("#J_ImgSwitcher"+b),this.audioSwitcher=a.one("#J_AudioSwitcher"+b),this.refresher=a.all("."+this.prefixCls+"checkcode-refresher"),this.img=a.one("#J_CheckCodeImg"+b),this.audioState=a.one("#J_AudioState"+b),this.audioStateText=a.one("#J_AudioStateText"+b),this.audioProgress=a.one("#J_AudioStateProgress"+b);var d={apiserver:this.apiserver,identity:this.identity,sessionid:this.sessionid,type:this.type};this.getImgURL=a.substitute(i.getImgURL,d),this.checkImgURL=a.substitute(i.checkImgURL,d),this.getAudioURL=a.substitute(i.getAudioURL,d),this.checkAudioURL=a.substitute(i.checkAudioURL,d),this.CREATED=!0},bind:function(){var b=this;this.bindImg(),this.bindAudio(),this.refresher.on("click",function(a){a.halt(),b.refresh(),b.focus()}),this.input.on("valuechange",function(b){b.prevVal&&0!==b.prevVal.length&&4!==b.prevVal.length||1!==b.newVal.length||(k=a.now())}).on("paste",function(){0===this.value.length&&(k=a.now())})},bindImg:function(){if(!this.img)return this;var a=this;return this.img&&this.img.on("click",function(){a.refresh(),a.focus()}).on("load",function(){}).on("error",function(){a.log({e:"IMGERROR"})}),this.imgSwitcher&&this.imgSwitcher.on("click",function(b){b.halt(),a.switchTo("img"),a.focus()}),this},bindAudio:function(){var a=this;return this.audioSwitcher.on("click",function(b){b.halt(),a.switchTo("audio"),a.refresh(),a.focus()}),this.audioStateText.on("click",function(b){b.halt(),a.audioOver&&(a.refresh(),a.focus())}),this},bindAudioProgress:function(){var a=this;this.audioSupport&&this.audio.on("timeupdate",function(){!g||this.duration&&1/0!==this.duration?a.progress(parseInt(100*this.currentTime/this.duration)):a.progress(100)},this.audio[0]).on("play",function(){},this.audio[0]).on("ended",function(){a.progress(100)},this.audio[0])},switchTo:function(b){if(!b||!a.isString(b))return this;var b=b.toUpperCase();return"IMG"===b?(this.audioCode.hide(),this.stopAudio(),this.imgCode.css({display:"block"}),this.codeType=b):"AUDIO"===b&&(this.imgCode.hide(),this.audioProgress.width(0),this.audioStateText.removeClass(this.prefixCls+"audio-replay"),this.audioCode.css({display:"block"}),this.codeType=b),this.checkedCode="",this.toggleRefresher(),this.SHOWED=!0,this.fire("switch"),this},toggleRefresher:function(){return"AUDIO"!==this.codeType?(this.refresher.show(),void 0):((!this.audioSupport||g)&&this.refresher.hide(),void 0)},refreshImg:function(){if(!this.getImgURL)return this;var b=this.getImgURL+(this.getImgURL.indexOf("?")>=0?"&t=":"?t=")+a.now();return this.img.attr("src",b),this},refreshAudio:function(){if(!this.getAudioURL)return this;var c=this.getAudioURL+(this.getAudioURL.indexOf("?")>=0?"&t=":"?t=")+a.now();if(this.stopAudio(),this.audioOver=!1,this.audioSupport)this.audioDuration=0,this.audio=a.one(new Audio(c)),this.audio[0].play(),this.bindAudioProgress();else if(f){var d=b.create("<bgsound>",{autostart:!0,id:"J_BgSound"+this.uid,src:c});b.append(d,"head"),this.player=a.one("#J_BgSound"+this.uid),this.progress("NOPROGRESS")}else a.one("body").append('<embed src="'+c+'" id="J_EmbedSound'+this.uid+'"'+(e?'type="application/x-mplayer2"':'type="audio/x-wav"')+" autostart hidden />"),this.player=a.one("#J_EmbedSound"+this.uid),this.progress("NOPROGRESS");return this},refresh:function(b){var b=a.isString(b)&&b?b.toUpperCase():this.codeType;"IMG"===b?this.refreshImg():"AUDIO"===b&&this.refreshAudio(),this.checkedCode="",this.fire("refresh"),j=k=a.now()},focus:function(){this.input[0].focus(),this.input[0].select()},stopAudio:function(){this.audioSupport?this.audio&&this.audio[0]&&this.audio[0].pause():this.player&&(this.player[0].src="",this.player.remove(),this.player=null)},replayAudio:function(){this.audioSupport&&this.audio&&(this.audio[0].currentTime=0,this.audio[0].pause(),this.audio[0].play())},showImg:function(){return this.switchTo("img"),this.refresh(),this},showAudio:function(){return this.switchTo("audio"),this},audioSupport:function(){try{return"Audio"in window&&(new Audio).canPlayType("audio/x-wav")}catch(a){return!1}}(),progress:function(a){switch(a){case-1:this.audioStateText.text("\u6b63\u5728\u52a0\u8f7d");break;case 100:case"NOPROGRESS":this.audioOver=!0,this.audioProgress.css({width:"0"}),this.audioStateText.addClass(this.prefixCls+"audio-over").text("\u70b9\u51fb\u64ad\u653e\u8bed\u97f3");break;default:this.audioStateText.removeClass(this.prefixCls+"audio-over").text("\u8bf7\u4ed4\u7ec6\u6536\u542c"),this.audioProgress.css({width:a+"%"})}},check:function(b){var c=a.trim(this.input.val()),b=a.isFunction(b)?b:function(){};if(!d.test(c))return b({success:!1,codeType:this.codeType}),void 0;if(this.checkedCode&&this.checkedCode===c)return b({success:!0,codeType:this.codeType}),void 0;if(l[c]=b,this.checkingCode){if(this.checkingCode===c)return;this.io&&this.io.abort&&this.io.abort()}this.checkingCode=c,a.later(function(){this._check()},500,!1,this)},_check:function(){function b(){"IMG"===e.codeType?e.refresh():(e.progress(100),e.stopAudio()),e.checkedCode="",l[d]&&l[d]({success:!1,codeType:e.codeType})}var c="IMG"==this.codeType?this.checkImgURL:this.checkAudioURL,d=a.trim(this.input.val()),e=this;e.io=a.io({url:c,data:{code:d},dataType:"jsonp",success:function(c){e.checkingCode="",e.log({t1:a.now()-k,t2:a.now()-j,s:c&&"SUCCESS."===c.message,t:e.codeType}),c&&"SUCCESS."===c.message?(e.progress(100),e.stopAudio(),e.checkedCode=d,l[d]&&l[d]({success:!0,codeType:e.codeType})):b()},error:function(){b()}})},log:function(b){if(b){var c=new Image;c.src="http://acjs.aliyun.com/captchaerror?"+a.param(b)}}}),a.checkcode=m,m});